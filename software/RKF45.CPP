/* File converted with FORTRAN CONVERTER utility.
   FORTRAN CONVERTER is written by Grigoriev D., 2081/4.*/

/*MARKERS: //! = probably incorrect, //? = possibly incorrect*/

#include "FORSYTHE.H"

//     METO PHE-KTTA EEPA ETBEPTOO-TOO OPKA

//     COCTABTE POPAMM-H.A.WATTS,L.F.SHAMPINE
//                SANDIA LABORATORIES
//              ALBUQUERQUE, NEW MEXICO

//     RKF45 PEHAHAEHA ABHM OPAOM  PEEH
//     HEECTKX  CAO ECTKX EPEHAHX PABHEH,
//     KOA BCEHE POBOHX HE CKOM OPOOCTOEE.
//     RKF45, BOOE OBOP,HE CEET COOBAT
//     EC OOBATE TPEETC BCOKA TOHOCT

//     PEME

//     OPOPAMMA RKF45 HTEPPET CCTEM  NEQN
//     OKHOBEHHX EPEHAHX PABHEH EPBOO
//     OPKA CEEO BA:

//            DY(I)/DT=F(T,Y(1),Y(2),...,Y(NEQN),

//     E Y(I) AAH B T.
//     OHO OPOPAMM PMEHT  HTEPPOBAH
//     OT T O TOUT, OHAKO EE MOHO COOBAT  KAK
//     OHOAOB HTEPATOP,TO POOT PEEHE HA
//     OH A B HAPABEH TOUT.HA BXOE APAMETPAM,
//     PPM B CCKE BOBA, PCBABATC HAEH,
//     HEOXOME  POOEH HTEPPOBAH. OO-
//     BATE HHO  EE PA OPATTC K RKF45
//     (,BOMOHO,OPEET HOBOE HAEHE  TOUT).
//     B ECTBTEHOCT RKF45-TO POPAMMA HTEPECA,
//     KOTOPA BBAET OPOPAMM RKFS, OCECTB
//     POECC PEEH.RKFS B CBO OEPE BBAET OPO-
//     PAMM FEHL, KOTOPA BCET PEHHOE PEEHE
//     HA OH A.

//     RKF45 COET METO PHE-KTTA-EEPA, OCAHH
//     B CEE KA:E.FEHLBERG,LOW-ORDER CLASSICAL
//     RUNGE-KUTTA FORMULAS WITH STEPSIZE CONTROL,NASA TR R-315

//     CT PAOT POPAMM RKF45 CTPPETC B CEX
//     KAX:L.F.SHAMPINE,H.A.WATTS,S.DAVENPORT, SOLVING
//     NON-STIFF ORDINARY DIFFERENTIAL EQUATIONS-THE STAT OF
//     THE ART,SANDIA LABORATORIES REPORT SAND75-0182,SIAM
//     REVIEW,18(1976), N3,376-411.

//     APAMETP POPAMM:

//     F       -OPOPAMMA F(T,Y,YP)  BCEH
//              POBOHX YP(I)=DY(I)/DT
//     NEQN    -CO HTEPPEMX PABHEH
//     Y(*)    -PEEHE B TOKE T
//     T       -HEABCMA EPEMEHHA
//     TOUT    -TOKA BXOA,B KOTOPO HHO OPEET
//              HAEHE PEEH
//     RELERR  -PAHA OTHOCTEHO OPEHOCT
//               TECTA OKAHO OK.
//     ABSERR  -PAHA ABCOTHO OPEHOCT
//               TECTA OKAHO OK.
//              HA KAOM AE POPAMMA TPEET BOHEH COB
//              ABS(LOCAL ERROR)<=RELERR*ABS(Y)+ABSERR
//               KAO KOMOHEHT BEKTOPOB OKAHO
//              OK  PEEH
//     IFLAG   -KAATE PEMA HTEPPOBAH.
//     WORK(*) -MACCB,COEPA HOPMA,BHTPEHH  RKF45,
//              KOTOPA HEOXOMA P OCEX BOBAX.EO
//              PAMEPHOCT OHA T HE MEHE 3+6*NEQN
//     IWORK(*)-E MACCB,COEPA HOPMA,BHTPEHH 
//              RKF45,KOTOPA HEOXOMA P OCEX BOBAX.
//              EO PAMEPHOCT OHA T HE MEHE 5.

//     EPBOE OPAEHE K RKF45

//     OOBATE OEH PECMOTPET B CBOE BBAE
//     POPAMME AMT  CEX MACCBOB, PPX
//     B CCKE BOBA- Y(NEQN), WORK(3+6*NEQN), IWORK(5);
//     KPOME TOO, OH OEH O'BT F B OEPATOPE EXTERNAL,
//     OOTOBT OPOPAMM F(T,Y,YP)  PCBOT HAA-
//     HE HAEH APAMETPAM-

//     NEQN  -CO HTEPPEMX PABHEH (NEQN>=1)
//     Y(*)  -BEKTOP HAAHX COB
//     T     -HAAHA TOKA HTEPPOBAH,
//            T OHO T EPEMEHHO.
//     TOUT  -TOKA BXOA,B KOTOPO HHO HAT HAEHE
//            PEEH. T=TOUT BOMOHO  P EPBOM
//            OPAEH.B TOM CAE BXO  RKF45 PO-
//            CXOT CO HAEHEM APAMETPA IFLAG=2,EC
//            MOHO POOAT HTEPPOBAHE.
//     RELERR-PAHA  OTHOCTEHO OKAH OPEHOCTE.
//     ABSERR-PAHA  ACOTHO    OKAH OPEHOCTE.
//            T PAH OH T HEOTPATEH.
//            RELERR OHA T EPEMEHHO,A ABSERR MOET
//            T  KOHCTAHTO.POPAMME, BOOE OBOP
//            HE CEET AABAT PAH  OTHOCTEHO
//            OK,MEH, EM PMEPHO 1.E-7. A EAT
//            TPHOCTE ,CBAHHX C OEH BCOKM APOCAM
//            K TOHOCT, POPAMMA TPEET,TO RELERR
//            A OE, EM HEKOTOP APAMETP OTHOCTEHO
//            OK,BCEM BHTP EE  ABC OT
//            MAH.B ACTHOCT,HE PAPEAETC AAHE TOKO
//            ACOTHO OK.EC E AAHO HAEHE RELERR,
//            MEHEE OCTMOO, TO RKF45 BEBAET RELERR
//            HAEAM OPAOM  BOBPAAET PABEHE O-
//            OBATE, PEE EM POOAT HTEPPOBAHE.
//     IFLAG-+1,-1.TO KAATE HACTPOK POPAMM  KAO
//            HOBO AA. HOPMAHOE BXOHOE HAEHE PABHO+1.
//            OOBATE OEH AABAT IFLAG=-1  B TOM
//            CAE,  KOA HEOXOMO PABEHE OHOAOBM
//            HTEPATOPOM.B TOM CAE RKF45 TAETC POOT
//            PEEHE HA OH A B HAPABEH TOUT P KAOM
//            OEPEHOM BOBE. OCKOK TOT PEM PAOT
//            BECMA HEKOHOMEH, EO CEET PMEHT
//             B CAE KPAHE HEOXOMOCT.

//     HOPMA HA BXOE

//     Y(*)    -PEEHE B TOKE T
//     T       -OCEH TOKA,OCTHTA P HTEPPOBAH.
//     IFLAG=2 -PHTEPPOBAH OCTHTO TOUT.TO HAEHE
//              APAMETPA KABAET HA CEH BXO 
//              BETC HOPMAHM PEMOM  POOEH
//              HTEPPOBAH.
//          =3 -HTEPPOBAHE HE O AKOHEHO -A TOO,
//              TO AAHHOE HAEHE PAH  OTHOCTEHO
//              OK OKAAOC CKOM MAO.  POOEH
//              HTEPPOBAH RELERR O HAEAM OPAOM
//              BEEHO.
//          =4 -HTEPPOBAHE HE O AKOHEHO -A TOO,
//              TO OTPEOBAOC OEE 3000 BCEH PO-
//              BOHO.TO COOTBETCTBYET PTEHO
//              500 AAM.
//          =5 -HTEPPOBAHE HE O AKOHEHO -A TOO,
//              TO PEEHE OPATOC B HY,BCECTBE EO
//              TECT TOKO OTHOCTEHO OK HE POXOT.
//               POOEH HEOXOMO HEHYEBOE HAEHE
//              APAMETPA ABSERR. COOBAHE HA OH A
//              PEMA OAOBOO HTEPPOBAH BETC
//              PAYMHM BXOOM  OOEH.
//          =6 -HTEPPOBAHE  HE O AKOHEHO -A TOO,
//              TO TPEYEMA TOHOCT HE MOA T OCTHTA
//              AE P HAMEHE OCT MO BEHE AA.
//              OOBATE OEH BET PAH OPE-
//              HOCT,PEE EM MOHO ET OTATC
//              POOAT HTEPPOBAHE.
//          =7 -O BCE BMOCT, RKF45 HEEKTBHA P
//              PEEH TO AA. CKOM OOE CO
//              TPEEMX BXOHX TOEK PETCTBET BOP
//              ECTECTBEHHO BEH AA.CEET COOBAT
//              PEM OAOBOO HTEPPOBAH.
//          =8 -HEPABHOE AAHE BXOHX APAMETPOB.TO
//              HAEHE OBETC,EC OEHA OHA 
//              CEX OOK-
//                              NEQN<=0
//                  T=TOUT    IFLAG!=+1   -1
//                  RELERR    ABSERR<0
//                  IFLAG==0   <-2   >8
//     WORK(*) -HOPMA, KOTOPA OHO HE PECTABET HTE-
//              PECA  OOBATE, HO HEOXOMA P OCE-
//              X BOBAX. WORK(1),...,WORK(NEQN) COEPAT
//              EPBE POBOHE BEKTOPA PEEH Y B TOKE T.
//              WORK(NEQN+1) XPAHT BEH AA H,C KOTOPO
//              MOHO OTATC POBECT CE A.
//     IWORK(*) -HOPMA, KOTOPA OHO HE PECTABET HTE-
//               PECA  OOBATE, HO HEOXOMA P OCE-
//               X BOBAX. B IWORK(1) COEPTC
//               CETK CA BCEH POBOHX.

//     OCEE OPAEH K RKF45

//          HA BXOE OPOPAMM RKF45 MEETC BC HOPMA,
//     HEOXOMA   POOEH HTEPPOBAH.EC P
//     HTEPPOBAH OCTHTO TOUT,TO OOBATE OCTA-
//     TOHO OPEET HOBOE HAEHE  TOUT  CHOBA OPATT-
//     C K RKF45.
//          B PEME OAOBOO HTEPPOBAH (IFLAG=-2)
//     OOBATE OEH MET B B,TO KA A
//     BOHETC B HAPABEH TEKEO HAEH TOUT
//     (CHAPEMOM  MEHEHEM IFLAG HA 2). OOBATE
//     OEH AAT HOBOE HAEHE TOUT  EPEOPEET
//     IFLAG HA -2, TO POOAT B PEME OAOBOO
//     HTEPPOBAH.
//          EC HTEPPOBAHE HE O AKOHEHO,HO
//     OOBATE XOET POOAT (CA IFLAG=3,4), OH
//     OPOCT CHOBA OPAAETC K RKF45.P IFLAG=3 APA-
//     METP RELERR   MEHEH HAEAM  POOEH
//     HTEPPOBAH OPAOM.B CAE IFLAG=4 CETK
//     CA HAEH HK ET EPEOPEEEH HA 0, 
//     T PAPEEH EE 3000 BCEH HK.
//          OHAKO B CAE IFLAG=5, PEE EM MOHO ET
//     POOAT HTEPPOBAHE,OOBATE OEH CHAAA
//     MEHT KPTEP OK, AAB OOTEHOE HAEHE
//      ABSERR. EC OH HE CEAET TOO, BOHEHE PO-
//     PAMM ET PEKPAEHO.
//        TOHO TAK E,B CAE IFLAG=6,PEE EM POO-
//     AT HTEPPOBAHE,OOBATE HEOXOMO EPEOPE-
//     ET IFLAG HA 2 ( -2, EC COETC PEM
//     OAOBOO HTEPPOBAH)  BET HAEHE 
//     ABSERR O RELERR,O   TOO,  POO.
//     EC TO HE ET CEAHO,BOHEHE POPAMM
//     PEKPAAETC. OBEHE IFLAG=6 KABAET HA HEPE-
//     PHOCT (PEEHE CTPO MEHETC , BOMOHO,
//     MEETC OCOEHHOCT), ACTO B OOHX CAX
//     HE MEET CMCA POOAT HTEPPOBAHE.
//          EC ET OEHO HAEHE IFLAG=7,TO OO-
//     BATE OEH EPET K PEM OAOBOO HTEPPO-
//     BAH C BEHO AA,OPEEEMO POPAMMO, 
//     PACCMOTPET BOMOHOCTT EPEXOA HA POPAMM METOOB
//     AAMCA.EC BCE E OOBATE XOET POOAT
//     HTEPPOBAHE O OPOPAMME RKF45,OH OEH O HOBOO
//     OPAEH K HE EPEOPEET IFLAG HA 2.B POTBHOM
//     CAE BOHEHE POPAMM ET PEKPAEHO.
//          EC OEHO HAEHE IFLAG=8,TO HTEPPOBAHE
//     HE POOAT,OKA HE T CPABEH OOHE
//     BXOHE APAMETP. HHO OTMETT,TO MACCB WORK 
//     IWORK COEPAT HOPMA,HEOXOM  AHEEO
//     HTEPPOBAH.OTOM B T MACCB HE BHOCT
//     MEHEH.

void
FEHL(void(F)(REAL T, REAL *Y, REAL *YP), int NEQN, const REAL *Y, REAL &T, REAL H, const REAL *YP, REAL *F1, REAL *F2, REAL *F3,
     REAL *F4, REAL *F5, REAL *S) {

//     METO PHE-KTTA-EEPA ETBEPTOO-TOO OPKA

//     OPOPAMMA FEHL HTEPPET CCTEM  NEQN
//     OKHOBEHHX EPEHAHX PABHEH EPBOO
//     OPKA CEEO BA

//          DY(I)/DT=F(T,Y(1),...Y(NEQN)),

//     E HAAHE HAEH Y(I)  HAAHE POBOHE
//     YP(I) AAH B HAAHO TOKE T. FEHL POOAET
//     PEEHE HA KCPOBAHH A H  OMEAET B MACCB
//     S(I) PEHE K PEEH B TOKE T+H, MEEE T
//     OPOK TOHOCT (OKAH OPOK PABEH ECT).
//     F1,...F5-MACCB PAMEPHOCT NEQN,HEOXOME BHTP
//     POPAMM.
//          B OPMAX POBEEHA PPOBKA C E
//     MEHT OTEP BEPHX HAKOB.
//          TO MOHO O PAAT PAHE HEABCME
//     APMEHT, P OPAEH K FEHL HE CEET AABAT
//      H HAEHE,MEHEE MHOEHHHO HA 13 OK
//     OKPEH B T.


    REAL CH;
    int K;

    CH = H / 4.0;
    for (K = 1; K <= NEQN; K++)F5[K - 1] = Y[K - 1] + CH * YP[K - 1];

    F(T + CH, F5, F1);
    CH = 3.0 * H / 32.0;
    for (K = 1; K <= NEQN; K++)F5[K - 1] = Y[K - 1] + CH * (YP[K - 1] + 3.0 * F1[K - 1]);
    F(T + 3.0 * H / 8.0, F5, F2);

    CH = H / 2197.0;
    for (K = 1; K <= NEQN; K++)
        F5[K - 1] = Y[K - 1] + CH * (1932.0 * YP[K - 1] + (7296.0 * F2[K - 1] - 7200.0 * F1[K - 1]));
    F(T + 12.0 * H / 13.0, F5, F3);

    CH = H / 4104.0;
    for (K = 1; K <= NEQN; K++)
        F5[K - 1] = Y[K - 1] + CH * ((8341.0 * YP[K - 1] - 845.0 * F3[K - 1]) +
                                     (29440.0 * F2[K - 1] - 32832.0 * F1[K - 1]));
    F(T + H, F5, F4);

    CH = H / 20520.0;
    for (K = 1; K <= NEQN; K++)
        F1[K - 1] = Y[K - 1] + CH * ((-6080.0 * YP[K - 1] + (9295.0 * F3[K - 1] - 5643.0 * F4[K - 1])) +
                                     (41040.0 * F1[K - 1] - 28352.0 * F2[K - 1]));
    F(T + H / 2.0, F1, F5);

//     BCT PEHHOE PEEHE B TOKE T+H

    CH = H / 7618050.0;
    for (K = 1; K <= NEQN; K++)
        S[K - 1] = Y[K - 1] + CH * ((902880.0 * YP[K - 1] + (3855735.0 * F3[K - 1] - 1371249.0 * F4[K - 1])) +
                                    (3953664.0 * F2[K - 1] + 277020.0 * F5[K - 1]));
}                            // END


void
RKFS(void(F)(REAL T, REAL *Y, REAL *YP), int NEQN, REAL *Y, REAL &T, REAL TOUT, REAL &RELERR, REAL &ABSERR, int &IFLAG,
     REAL *YP, REAL H, REAL *F1, REAL *F2, REAL *F3, REAL *F4, REAL *F5, REAL SAVRE, REAL SAVAE) {

//     METO PHE-KTTA-EEPA ETBEPTOO-TOO OPKA
//     RKFS HTEPPET CCTEM OKHOBEHHX E-
//     PEHAHX PABHEH EPBOO OPKA(CM. KOM-
//     MEHTAP K RKF45). MACCB YP,F1,F2,F3,F4  F5
//     (PAMEPHOCT O KPAHE MEPE NEQN)  EPEMEH-
//     HE H,SAVRE,SAVAE,NFE,KOP,INIT,JFLAG  KFLAG
//     COTC BHTP POPAMM  BHECEH B
//     CCOK BOBA,TO COXPAHT X OPEEEH-
//     HOCT P OBTOPHOM OPAEH.OTOM X HA-
//     EH HE OH  MEHTC  OOBATEEM.
//     BOMOH HTEPEC PECTABT APAMETP
//     YP  -POBOHA BEKTOPA PEEH B TOKE T
//     H   -PEOAAEM PAMEP AA  OEPEHOO TAA
//     NFE -CETK CA BCEH HK

    bool HFAILD, OUTPUT;
    static int NFE,KOP, INIT, JFLAG, KFLAG;
    REAL A, AE, DT, EE, EEOET, ESTTOL, ET, HMIN, RER, S, SCALE, TOL, TOLN, U26, EPSP1, EPS, YPK;
    int K, MFLAG;


//     REMIN-TO MHMAHOE OCTMOE HAEHE 
//     RELERR.OTK OT O TO OPOPAMME
//     OEE BCOK TOHOCT OHO CTOT OEH
//     OPOO  AACT ECEH.

    REAL REMIN = 1.E-12;

//     CTOMOCT CETA KOHTPOPETC TPEOBAHEM,
//     TO KOECTBO BCEH HK O O-
//     PAHEHO BEHO,PTEHO PABHO HA-
//     EH APAMETPA MAXNFE.PHTOE EC HAE-
//     HE PMEPHO COOTBETCTBET 500 AAM.

    int MAXNFE = 3000;

//     POBEPT BXOHE APAMETP

    if (NEQN < 1)goto _10;
    if ((RELERR < 0.0) || (ABSERR < 0.0))goto _10;
    MFLAG = ABS(IFLAG);
    if ((MFLAG == 0) || (MFLAG > 8))goto _10;
    if (MFLAG != 1)goto _20;

//     EPB BOB,BCT MAHHOE COH

    EPS = 1.0;
    _5:;
    EPS = EPS / 2.0;
    EPSP1 = EPS + 1.;
    if (EPSP1 > 1.)goto _5;
    U26 = 26. * EPS;
    goto _50;

//     OKA BXOHO HOPMA

    _10:;
    IFLAG = 8;
    return;  //?

//     POBEPT BOMOHOCT POOEH

    _20:;
    if ((T == TOUT) && (KFLAG != 3))goto _10;
    if (MFLAG != 2)goto _25;

//     IFLAG=+2  -2

    if ((KFLAG == 3) || (INIT == 0))goto _45;
    if (KFLAG == 4)goto _40;
    if ((KFLAG == 5) && (ABSERR == 0.0))goto _30;
    if ((KFLAG == 6) && (RELERR <= SAVRE) && (ABSERR <= SAVAE))goto _30;
    goto _50;

//     IFLAG=3,4,5,6,7  8

    _25:;
    if (IFLAG == 3)goto _45;
    if (IFLAG == 4)goto _40;
    if ((IFLAG == 5) && (ABSERR > 0.0))goto _45;

//     HTEPPOBAHE HE POOAT,OCKOK O-
//     OBATE HE BOH HCTPK,COOTBETCTBX
//     HAEHM IFLAG=5,6,7  8

    _30:;
//printf("HTEPPOBAHE PEPBAHO, OCKOK OOBATE"
//"HE BOH HCTPK RKF45, COOTBETCTBX"
//"HAEHM IFLAG=5,6,7  8");
    exit(0);

//     EPEOPEET CETK CA BCEH HK

    _40:;
    NFE = 0;
    if (MFLAG == 2)goto _50;

//     EPEOPEET HAEHE FLAG,CTAHOBEHHOE
//     P PEEM OPAEH

    _45:;
    IFLAG = JFLAG;
    if (KFLAG == 3)MFLAG = ABS(IFLAG);

//     COXPAHT BXOHOE HAEHE IFLAG  CTAHOBT
//     HAEHE FLAG, COOTBETCTBEE POOEH,
//      E POBEPK

    _50:;
    JFLAG = IFLAG;
    KFLAG = 0;

//     COXPAHT HAEH RELERR  ABSERR  BXOHO
//     POBEPK P OCEX OPAEHX

    SAVRE = RELERR;
    SAVAE = ABSERR;

//     CTAHOBT HAEHE PAH  OTHOCTE-
//     HO OPEHOCT,PABHOE KAK MHMM 2*EPS+
//     REMIN,TO EAT TPHOCTE,CBAHHX
//     C TPEOBAHEM HEOCTMO TOHOCT

    RER = 2. * EPS + REMIN;
    if (RELERR >= RER)goto _55;

//     AAHHA PAHA OTHOCTEHO OPEHOCT
//     CKOM MAA

    RELERR = RER;
    IFLAG = 3;
    KFLAG = 3;
    return;  //?

    _55:;
    DT = TOUT - T;

    if (MFLAG == 1)goto _60;
    if (INIT == 0)goto _65;
    goto _80;

//     PCBOEHE HAAHX HAEH (HPOBA-
//             HE)-CTAHOBT HAEHE KAATE
//             OKOHAH HPOBAH,INIT
//             CTAHOBT HAEHE KAATE C-
//             KOM OOO ATPEOBAHHOO CA B-
//             XOHX TOEK,KOP
//             BCT HAAHE POBOHE
//             CTAHOBT HAEHE CETKA CA
//             BCEH HK,NFE
//             OEHT HAEH BEH AA

    _60:;
    INIT = 0;
    KOP = 0;

    A = T;
    F(A, Y, YP);
    NFE = 1;
    if (T != TOUT)goto _65;
    IFLAG = 2;
    return;  //?

    _65:;
    INIT = 1;
    H = ABS(DT);
    TOLN = 0.;
    for (K = 1; K <= NEQN; K++) {   //? target=70
        TOL = RELERR * ABS(Y[K - 1]) + ABSERR;
        if (TOL <= 0)goto _70;
        TOLN = TOL;
        YPK = ABS(YP[K - 1]);
        if (YPK * pow(H, 5) > TOL)H = pow((TOL / YPK), 0.2);
        _70:;
    }                            // CONTINUE
    if (TOLN <= 0.0)H = 0.0;
    H = MAX(H, U26 * MAX(ABS(T), ABS(DT)));
    JFLAG = SIGN(2, IFLAG);

//     PCBOT BEHE AA HAK,COOTBETCTB
//     HTEPPOBAH B HAPABEH OT T K TOUT

    _80:;
    H = SIGN(H, DT);

//     POBEPKA, HACKOKO CEPEHO BHE HA RKF45
//     CKOM OOO ATPEOBAHHOO CA BXO-
//     HX TOEK

    if (ABS(H) >= 2.0 * ABS(DT))KOP = KOP + 1;
    if (KOP != 100)goto _85;

//     PEMEPHA ACTOTA BXOOB

    KOP = 0;
    IFLAG = 7;
    return;

    _85:;
    if (ABS(DT) > U26 * ABS(T))goto _95;

//     EC OEH KO K TOKE BXOA,POKCTPAO-
//     POBAT  BEPHTC O MECT BOBA

    for (K = 1; K <= NEQN; K++)Y[K - 1] = Y[K - 1] + DT * YP[K - 1];
    A = TOUT;
    F(A, Y, YP);
    NFE = NFE + 1;
    goto _300;

//     PCBOT HAAHOE HAEHE HKATOP TOK
//     BXOA

    _95:;
    OUTPUT = false;

//     TO EAT HEOPABAHHOO MAHHOO H
//     P BCEH HK OT PAH OPEHO-
//     CTE,POMACTAPOBAT T PAH

    SCALE = 2. / RELERR;
    AE = SCALE * ABSERR;

//     OAOBOE HTEPPOBAHE

    _100:;
    HFAILD = false;

//     CTAHOBT HAMEH OCTM BEH AA

    HMIN = U26 * ABS(T);

//     CPABT P HEOXOMOCT BEH AA,
//     TO OCTHT TOK BXOA. PACCTAT HA
//     BA AA BEPE,TO EAT CKOM PEKX
//     MEHEH B BEHE AA  TEM CAMM MEH-
//     T BHE BXOHX TOEK HA POPAMM.

    DT = TOUT - T;
    if (ABS(DT) >= 2. * ABS(H))goto _200;
    if (ABS(DT) > ABS(H))goto _150;

//     CE CEH A ABEPT HTEPPO-
//     BAHE O KAAHHO TOK BXOA

    OUTPUT = true;
    H = DT;
    goto _200;

    _150:;
    H = 0.5 * DT;



//     BHTPEHH OHOAOB HTEPATOP

//     PAH OPEHOCTE  POMACTAPOBAH,
//     TO EAT HEOPABAHHOO MAHHOO H
//     P BCEH HK OT HX.
//     TO EAT OPAEH B H HAMEHATE
//     B TECTE,OTHOCTEHA OKA MEPETC  O
//     OTHOEH K CPEHEM   BEH PEEH
//     B HAAE  KOHE AA.
//     B OPME,OEHBAE OK,POBEEHA
//     PPOBKA CAAEMX,MEHAA OTEP
//     BEPHX HAKOB.
//     TO PAAT ME COO PAHE APMEHT,
//      H HE OCKATC HAEH,MEHE MHO-
//     EHHO HA 26 OK OKPEH B T.
//     BBEEH PAKTECKE OPAHEH HA CKOPOCT
//     MEHEH BEH AA,TO CAT PO-
//     ECC BOPA TO BEH  EAT PEMEP-
//     HOO EE PAPOCA B AAAX C HAPEHEM HEPE-
//     PBHOCT.
//      PEOCTOPOHOCT POPAMMA EPET 9/10 OT TO
//     BEH AA,KOTOPA HHA O EE OEHKE.
//     ECHA AHHOM AE A HEAHA OTKA
//     TO P AHPOBAH CEEO BEEHE
//     H AA HE OCKAETC. TO OBAET EK-
//     TBHOCT POPAMM  AA C PAPBAM 
//     B OEM CAE,OCKOK COETC OKA-
//     HA KCTPAO  OOHTEHA PEOCTO-
//     POHOCT KAETC OPABAHHO.


//     POBEPT CO BCEH POBOHX.EC
//     OHO HE PEBAET CTAHOBEHHOO PEEA,O-
//     POOBAT POOT HTEPPOBAHE C T O T+H

    _200:;
    if (NFE <= MAXNFE)goto _220;

//     CKOM OA PAOTA

    IFLAG = 4;
    KFLAG = 4;
    return;

//     POOT PEHHOE PEEHE HA OH A H H

    _220:;
    FEHL(F, NEQN, Y, T, H, YP, F1, F2, F3, F4, F5, F1);
    NFE = NFE + 5;

//     BCT  CPABHT OCTME PAH 
//     OEHK OKAHO O,A ATEM CHT MACTA-
//     POBAHE PAH.AMETTE,TO OTHOCTEHA
//     OKA MEPETC O OTHOEH K CPEHEM 
//     BEH PEEH B HAAE  KOHE AA.

    EEOET = 0.;
    for (K = 1; K <= NEQN; K++) {   //? target=250
        ET = ABS(Y[K - 1]) + ABS(F1[K - 1]) + AE;
        if (ET > 0.)goto _240;

//     HEPABHA PAHA OPEHOCT

        IFLAG = 5;
        KFLAG = 5;
        return;

        _240:;
        EE = ABS((-2090. * YP[K - 1] + (21970. * F3[K - 1] - 15048. * F4[K - 1])) +
                 (22528. * F2[K - 1] - 27360. * F5[K - 1]));
//_250:;
        EEOET = MAX(EEOET, EE / ET);
    }

    ESTTOL = ABS(H) * EEOET * SCALE / 752400.;

    if (ESTTOL <= 1.0)goto _260;


//     HEAH A
//            MEHT BEH AA  CHOBA O-
//            POOBAT
//            MEHEHE OPAHBAETC CH MHO-
//            TEEM 1/10

    HFAILD = true;
    OUTPUT = false;
    S = 0.1;
    if (ESTTOL < 59049.)S = 0.9 / pow(ESTTOL, 0.2);
    H = S * H;
    if (ABS(H) > HMIN)goto _200;

//     AAHHA PAHA OK HEOCTMA AE P
//     HAMEHE OCTMO BEHE AA

    IFLAG = 6;
    KFLAG = 6;
    return;  //?


//     CEH A
//            OMECTT B MACCB Y PEEHE B TOKE
//            T+H  BCT POBOHE B TO
//            TOKE

    _260:;
    T = T + H;
    for (K = 1; K <= NEQN; K++)Y[K - 1] = F1[K - 1];
    A = T;
    F(A, Y, YP);
    NFE = NFE + 1;


//     BPAT BEH CEEO AA
//     BEEHE OPAHEHO MHOTEEM 5
//     EC HA AHHOM AE A HEAHA
//     OTKA,TO  CEEO HE O-
//     CKAETC BOP OE BEH AA

    S = 5.;
    if (ESTTOL > 1.889568E-4)S = 0.9 / pow(ESTTOL, 0.2);
    if (HFAILD)S = MIN(S, 1.0);
    H = SIGN(MAX(S * ABS(H), HMIN), H);

//     KOHE OHOAOBOO HTEPATOPA


//     HHO  EAT OEPEHO A

    if (OUTPUT)goto _300;
    if (IFLAG > 0)goto _100;


//     HTEPPOBAHE CEHO ABEPEHO

//     PEM OHOAOBOO HTEPPOBAH

    IFLAG = -2;
    return;

//     PEM HTEPPOBAH HA HTEPBAE

    _300:;
    T = TOUT;
    IFLAG = 2;
}                            // END

void
RKF45(void(F)(REAL T, REAL *Y, REAL *YP), int NEQN, REAL *Y, REAL &T, REAL TOUT, REAL &RELERR, REAL &ABSERR, REAL *WORK,
      int &IFLAG) {
//     EC TPAHCTOP POBEPET HEKC, TO AMEHT
//     WORK[0] HA WORK[2+6*NEQN]

    int K1, K2, K3, K4, K5, K6, K1M;

//     BCT HEKC  PACEEH PAOEO MACCBA

    K1M = NEQN;
    K1 = K1M + 1;
    K2 = K1 + NEQN;
    K3 = K2 + NEQN;
    K4 = K3 + NEQN;
    K5 = K4 + NEQN;
    K6 = K5 + NEQN;

//     TA POMEYTOHA POPAMMA POCTO COKPAAET 
//     OOBATE HH CCOK BOBA YTEM PACEEH
//     BYX PAOX MACCBOB. EC TO HE COBMECTMO C
//     TPAHCTOPOM,TO OH OEH OPAATC HEOCPECTBEHHO
//     K OPOPAMME RKFS .

    RKFS(F, NEQN, Y, T, TOUT, RELERR, ABSERR, IFLAG, WORK, WORK[K1M], &WORK[K1], &WORK[K2], &WORK[K3], &WORK[K4],
         &WORK[K5], WORK[K6], WORK[K6 + 1]);
}                            // END


